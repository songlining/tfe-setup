# Ingress Resource for TFE - TLS Re-encryption Mode
#
# In this mode:
# 1. nginx terminates client-facing TLS using its own certificate (from Vault PKI)
# 2. nginx re-encrypts traffic to TFE backend using HTTPS (TLS re-encryption)
#
# Why re-encryption instead of termination-to-HTTP?
# - TFE's internal nginx always redirects HTTP to HTTPS when the Host header matches TFE_HOSTNAME
# - TFE does not honor X-Forwarded-Proto headers for its redirect logic
# - Therefore, nginx must connect to TFE's HTTPS port (443 -> 8443)
#
# Benefits of this configuration:
# - nginx can apply its own WAF rules, rate limiting, etc.
# - nginx serves the edge certificate (can be different from TFE's internal cert)
# - Traffic inside the cluster is still encrypted (end-to-end TLS)
#
# IMPORTANT: This configuration conflicts with TLS passthrough mode
# - Only ONE option can be active at a time for the same host
# - To switch to passthrough: kubectl delete -f tls-termination-ingress.yaml
# - Then: kubectl apply -f tls-passthrough-ingress.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tfe-ingress-termination
  namespace: tfe
  annotations:
    # Configure nginx backend protocol
    # TFE always serves HTTPS on 8443, so we use HTTPS for backend connection
    # nginx terminates client TLS and re-encrypts to TFE (TLS re-encryption)
    nginx.ingress.kubernetes.io/backend-protocol: HTTPS

    # Configure proxy settings for TFE
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"

    # Configure timeouts for long-running TFE operations (runs, applies, state uploads)
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"

    # Configure upload size (TFE may need large uploads for state files, modules, etc.)
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"

    # Enable WebSocket support for TFE real-time features (live logs, etc.)
    nginx.ingress.kubernetes.io/websocket-services: "terraform-enterprise"

    # Pass the original host header to TFE
    nginx.ingress.kubernetes.io/upstream-vhost: "tfe.tfe.local"

    # Force SSL redirect (HTTP -> HTTPS)
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # X-Forwarded headers are configured at the controller level in nginx values.yaml
    # (use-forwarded-headers: "true") so TFE knows requests came via HTTPS

spec:
  # Use the nginx ingress class
  ingressClassName: nginx

  # TLS configuration with certificate from Vault
  tls:
    - hosts:
        - tfe.tfe.local
      secretName: tfe-tls-cert  # Created by setup-tls-cert.sh script

  rules:
    - host: tfe.tfe.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: terraform-enterprise
                port:
                  number: 443  # TFE HTTPS port (nginx re-encrypts to backend)
