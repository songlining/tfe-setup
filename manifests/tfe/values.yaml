# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0
#
# TFE Helm Values for Kind Cluster Deployment
# This file configures Terraform Enterprise for deployment on Kubernetes
# with local dependencies (MinIO, Redis, PostgreSQL, Vault for TLS)

# Replica count for TFE pods
replicaCount: 1

# Image pull secret to use for registry authentication
imagePullSecrets:
  - name: terraform-enterprise

# Image configuration for Terraform Enterprise
# Note: The tag should match your license version (format: vYYYYMM-#)
image:
  repository: images.releases.hashicorp.com
  name: hashicorp/terraform-enterprise
  # Use amd64-specific tag that was pre-loaded into kind via ctr import
  # The original v202507-1 is a multi-arch manifest that doesn't include arm64
  # On Apple Silicon, this runs via QEMU binfmt emulation
  tag: v202507-1-amd64
  # Use Never since image is pre-loaded into kind's containerd
  pullPolicy: Never

# Service account configuration
serviceAccount:
  enabled: true
  annotations: {}
  labels: {}

# Pod configuration
pod:
  annotations: {}
  labels: {}

# Container security context
container:
  securityContext: {}

# Resource limits and requests
# Reduced for kind cluster with limited resources
# Note: This may cause performance issues for larger TFE workloads
resources:
  requests:
    memory: "2000Mi"
    cpu: "500m"
  limits:
    memory: "4000Mi"
    cpu: "2000m"

# TLS configuration using certificates from Vault
# NOTE: For production, you should fetch these certificates from Vault
# and create a Kubernetes secret. For development, we'll configure
# the chart to use the certificates.
tls:
  certificateSecret: terraform-enterprise-certificates
  caCertBaseDir: /etc/ssl/certs
  caCertFileName: custom_ca_certs.pem
  certMountPath: /etc/ssl/private/terraform-enterprise/cert.pem
  keyMountPath: /etc/ssl/private/terraform-enterprise/key.pem
  # The actual certificate data should be base64 encoded PEM files
  # For this deployment, we'll use placeholder values that need to be
  # populated from Vault PKI
  certData: ""
  keyData: ""
  caCertData: ""

# TFE-specific configuration
tfe:
  metrics:
    enable: false
    httpPort: 9090
    httpsPort: 9091
    privateHttpPort: 8080
    privateHttpsPort: 8443

# Node selector for pod assignment
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity settings
# Note: No nodeAffinity constraint for architecture since the amd64 image
# runs via QEMU emulation on arm64 nodes (Apple Silicon)
affinity: {}

# Topology spread constraints
topologySpreadConstraints: []

# Security context for the deployment
# TFE requires specific permissions to write to log directories and set file permissions
# Using fsGroup to ensure volume mounts are writable by the TFE process
securityContext:
  fsGroup: 1000

# Init containers - could be used to fetch certificates from Vault
initContainers: null

# Ingress configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: ""
      paths:
        - path: /
          pathType: Prefix
          serviceName: "terraform-enterprise"
          portNumber: 443
  tls: []

# Service configuration
service:
  annotations: {}
  type: LoadBalancer
  port: 443
  nodePort: 30443
  loadBalancerIP: null

# Agent worker pod template
agentWorkerPodTemplate: {}

# OpenShift configuration
openshift:
  enabled: false

# Environment configuration
env:
  # Reference to external config files (optional)
  # configFilePath: env-config.yaml
  # secretsFilePath: env-secrets.yaml

  # References to existing ConfigMaps and Secrets
  configMapRefs: []
  secretRefs: []

  # Secret values (these will be created as Kubernetes secrets)
  # NOTE: These are placeholder values. In production, use external secrets management
  secrets:
    # TFE License - raw value (Helm chart will base64 encode)
    # The license file is at: /Users/larry.song/work/hashicorp/tfe-setup/tfe.license
    TFE_LICENSE: ""

    # Database password (from postgresql-credentials secret in psql namespace)
    TFE_DATABASE_PASSWORD: "tfepassword123"

    # S3 credentials (from minio-credentials secret in s3 namespace)
    TFE_OBJECT_STORAGE_S3_ACCESS_KEY_ID: "minioadmin"
    TFE_OBJECT_STORAGE_S3_SECRET_ACCESS_KEY: "minioadmin123"

    # Redis password (from redis-credentials secret in redis namespace)
    TFE_REDIS_PASSWORD: "redispassword123"

    # Encryption password for TFE (should be set to a secure value)
    # IMPORTANT: Change this to a secure value in production!
    TFE_ENCRYPTION_PASSWORD: "ChangeThisSecurePassword123!"

  # Regular environment variables (these will be created as ConfigMap entries)
  variables:
    # TFE hostname - this is the DNS name that will be used to access TFE
    # For local development, we'll use tfe.local which should resolve
    # via our dnsmasq service
    TFE_HOSTNAME: "tfe.tfe.local"

    # TFE Capacity settings
    TFE_CAPACITY_CONCENCY: "10"
    TFE_CAPACITY_CPU: "1000"
    TFE_CAPACITY_MEMORY: "4096"

    # Database configuration
    # PostgreSQL service in the psql namespace
    TFE_DATABASE_HOST: "postgresql.psql.svc.cluster.local:5432"
    TFE_DATABASE_NAME: "tfe"
    TFE_DATABASE_USER: "tfe"
    TFE_DATABASE_PARAMETERS: "sslmode=disable"

    # Disk path for local storage
    TFE_DISK_PATH: "/terraform-enterprise"

    # Object Storage (S3) configuration
    # Using MinIO in the s3 namespace
    TFE_OBJECT_STORAGE_TYPE: "s3"
    TFE_OBJECT_STORAGE_S3_BUCKET: "tfe"
    TFE_OBJECT_STORAGE_S3_ENDPOINT: "http://minio.s3.svc.cluster.local:9000"
    TFE_OBJECT_STORAGE_S3_REGION: "us-east-1"
    TFE_OBJECT_STORAGE_S3_USE_INSTANCE_PROFILE: "false"

    # Redis configuration
    # Redis service in the redis namespace
    TFE_REDIS_HOST: "redis.redis.svc.cluster.local:6379"
    TFE_REDIS_USE_TLS: "false"
    TFE_REDIS_USE_AUTH: "true"

    # IACT (Interactive Authentication and Authorization Tokens) settings
    # Limit which subnets can create IACTs (empty means no restriction)
    TFE_IACT_SUBNETS: "0.0.0.0/0"
    TFE_IACT_TIME_LIMIT: "1209600"  # 14 days in seconds

    # TLS settings
    TFE_TLS_CIPHERS: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"

    # Run pipeline Kubernetes settings
    TFE_RUN_PIPELINE_KUBERNETES_DEBUG_ENABLED: "false"
    TFE_RUN_PIPELINE_KUBERNETES_DEBUG_JOBS_TTL: "86400"

# Agents configuration
agents:
  rbac:
    enabled: true
  annotations: {}
  labels: {}
  namespace:
    enabled: true
    annotations: {}
    labels: {}
